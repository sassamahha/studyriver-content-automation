import os
import json
import re
from datetime import datetime
from openai import OpenAI

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

INPUT_FILE = "tmp/news.json"
OUTPUT_DIR = "posts/news/main/"

def sanitize_title(title):
    return re.sub(r"[^a-zA-Z0-9\-]", "-", title.lower()).strip("-")

def build_messages(news):
    title = news["articles"][0]["title"]
    url = news["articles"][0]["url"]
    desc = news["articles"][0]["description"]

    print("ğŸŸ¡ DEBUG: Promptãƒ“ãƒ«ãƒ‰ä¸­ (ã‚¿ã‚¤ãƒˆãƒ«):", title)
    
    user_prompt = f"""ä»¥ä¸‹ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ã‚‚ã¨ã«ã€æœªæ¥ä»®èª¬ãƒ¡ãƒ‡ã‚£ã‚¢ã€StudyRiverï¼ˆã‚¹ã‚¿ãƒªãƒï¼‰ã€å‘ã‘ã®â€œé›‘èªŒé¢¨èª­ã¿ç‰©â€è¨˜äº‹ã‚’æ§‹æˆã—ã¦ãã ã•ã„ã€‚

ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘
ã‚¿ã‚¤ãƒˆãƒ«: {title}
URL: {url}
æ¦‚è¦: {desc}

--- å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ---
# ï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ã‚‚ã¨ã«ã—ãŸã€æ—¥æœ¬èªã®ä»®èª¬çš„ãªå•ã„ã‹ã‘ã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ãã ã•ã„ï¼‰

{{ãƒªãƒ¼ãƒ‰æ–‡ã¨ã—ã¦ã€ä»Šèµ·ãã¦ã„ã‚‹å‡ºæ¥äº‹ã‚„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«è§¦ã‚ŒãŸã‚ã¨ã€ã€Œã“ã®æµã‚ŒãŒç¶šã„ãŸã‚‰ï¼Ÿã€ã¨ã„ã†å•ã„ã‚’æç¤ºã—ã€èª­è€…ã«IFã‚’æŠ•ã’ã‹ã‘ã¦ãã ã•ã„}}

## 1. ä»Šæ—¥ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼šä½•ãŒèµ·ãã¦ã„ã‚‹ã®ã‹ï¼Ÿ
- **å¼•ç”¨å…ƒ**: [{{URL}}]
- **ç°¡å˜ãªè¦ç´„ï¼ˆé«˜å’ã§ã‚‚ç†è§£ã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã®æ—¥æœ¬èªã§ï¼‰**ï¼š  
  {{å°‚é–€ç”¨èªã¯å™›ã¿ç •ã„ã¦ã€‚ã§ãã‚Œã°ç®‡æ¡æ›¸ãã§ã€æ§‹é€ çš„ã«3ãƒã‚¤ãƒ³ãƒˆç¨‹åº¦}}

## 2. IFï¼šã‚‚ã—ã“ã®ã¾ã¾é€²ã‚“ã ã‚‰ã€æœªæ¥ã¯ã©ã†ãªã‚‹ï¼Ÿ
â†’ å„ä»®èª¬ã¯ä»¥ä¸‹ã®å½¢å¼ã§ã€ç‰©èªã‚’èªã‚‹ã‚ˆã†ã«ã€Œ3ã¤ï¼ˆIF1,IF2,IF3ï¼‰ã€å±•é–‹ã—ã¦ãã ã•ã„ã€‚
> **ä»®èª¬1ï¼ˆãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ï¼‰ï¼šâ—‹â—‹ãŒå½“ãŸã‚Šå‰ã«ãªã‚‹æœªæ¥**  
> {{ä»®èª¬1ã®èª¬æ˜}}

> **ä»®èª¬2ï¼ˆæ¥½è¦³çš„ï¼‰ï¼šâ—‹â—‹ãŒå¤§ããç™ºå±•ã™ã‚‹æœªæ¥**  
> {{ä»®èª¬2ã®èª¬æ˜}}

> **ä»®èª¬3ï¼ˆæ‚²è¦³çš„ï¼‰ï¼šâ—‹â—‹ãŒå¤±ã‚ã‚Œã¦ã„ãæœªæ¥**  
> {{ä»®èª¬3ã®èª¬æ˜}}

â†’ èª¬æ˜ã¯ä»¥ä¸‹ã®ï¼“æ§‹æˆã§ã€æ–‡ç« ã¯è‡ªç„¶ã«ã¤ãªã„ã§ãã ã•ã„ã€‚
- æœ€åˆã«ç›´æ¥çš„ãªå¤‰åŒ–
- æ¬¡ã«æ³¢åŠçš„ãªå¤‰åŒ–
- æœ€å¾Œã«ä¾¡å€¤è¦³ã®å¤‰åŒ–

## 3. ä»Šã€ç§ãŸã¡ã«ã§ãã‚‹é¸æŠè‚¢ã¯ï¼Ÿ
- **è¡Œå‹•æ¡ˆ**ï¼ˆè¤‡æ•°ã®ç«‹å ´ã‹ã‚‰ï¼‰
- **è€ƒãˆæ–¹ã®ãƒ’ãƒ³ãƒˆ**

## 4. ãƒ¯ãƒ¼ã‚¯ï¼šã‚ãªãŸãªã‚‰ã©ã†ã™ã‚‹ï¼Ÿ
â†’ èª­è€…ã«3ã¤ã®é¸æŠè‚¢ã‚’å‡ºã—ã¦å•ã„ã‹ã‘ã¾ã™ã€‚ç¤¾ä¼šãƒ»ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãƒ»å€‹äººè¦–ç‚¹ãªã©ã€æœªæ¥ã¸ã®é–¢ã‚ã‚Šæ–¹ã®é•ã„ãŒå‡ºã‚‹ã‚ˆã†ã«ã€‚

## 5. ã¾ã¨ã‚ï¼š10å¹´å¾Œã‚’äºˆç¿’ã—ã¦ã€ä»Šæ—¥ã‚’é¸ã¶ãŸã‚ã«
â†’ ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿ƒã™ã‚ˆã†ãªèª­è€…ã¸ã®å•ã„ã‹ã‘ã§ç· ã‚ã€é›‘èªŒé¢¨ã«æ›¸ã„ã¦ãã ã•ã„ã€‚  
ä¾‹ï¼šã€Œã‚ãªãŸã¯ã©ã‚“ãªæœªæ¥ã‚’æ€ã„æãã¾ã—ãŸã‹ï¼ŸSNSå¼•ç”¨ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã§ãœã²æ•™ãˆã¦ãã ã•ã„ã€‚ã€"""

    return [
        {
            "role": "system",
            "content": "ã‚ãªãŸã¯ã€StudyRiverï¼ˆã‚¹ã‚¿ãƒªãƒï¼‰ã€ã®æœªæ¥ä»®èª¬ãƒ¡ãƒ‡ã‚£ã‚¢ã«è¨˜äº‹ã‚’å¯„ç¨¿ã™ã‚‹ã€èª­è€…ã¨ã®ä¼šè©±ã‚’å¤§åˆ‡ã«ã™ã‚‹é›‘èªŒãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚å°‚é–€çš„ã™ããšã€è¦ªã—ã¿ã‚„ã™ãã€æƒ³åƒã‚’å¼•ãå‡ºã™æ–‡ç« ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚"
        },
        {
            "role": "user",
            "content": user_prompt
        }
    ]

def generate_article(messages):
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=messages,
        temperature=0.7,
        max_tokens=1500
    )
    return response.choices[0].message.content

def save_markdown(title, content):
    date_str = datetime.now().strftime("%Y-%m-%d")
    slug = sanitize_title(title)[:40]
    filename = f"{OUTPUT_DIR}{date_str}-{slug}.md"
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    with open(filename, "w", encoding="utf-8") as f:
        f.write(content)
    print(f"âœ… Saved: {filename}")

def main():
    with open(INPUT_FILE, "r", encoding="utf-8") as f:
        news = json.load(f)

    if not news.get("articles"):
        print("âŒ ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
        return
    
    messages = build_messages(news)
    article = generate_article(messages)
    title = news["articles"][0]["title"]
    save_markdown(title, article)

if __name__ == "__main__":
    main()
