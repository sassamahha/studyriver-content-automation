import os
import json
import re
from datetime import datetime
from openai import OpenAI

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

INPUT_FILE = "tmp/news_kids_mind.json"
OUTPUT_DIR = "posts/news/kids_mind/"

def sanitize_title(title):
    return re.sub(r"[^a-zA-Z0-9\-]", "-", title.lower()).strip("-")

def build_messages(news):
    title = news["articles"][0]["title"]
    url = news["articles"][0]["url"]
    desc = news["articles"][0]["description"]

    user_prompt = f"""å°å­¦æ ¡ä½ã€œä¸­å­¦å¹´ã®ã“ã©ã‚‚ã¨ä¿è­·è€…ã‚’å¯¾è±¡ã«ã€Œã“ã“ã‚ã®æ‰±ã„æ–¹ã€ã‚’ãƒ†ãƒ¼ãƒã¨ã—ãŸèª­ã¿ç‰©è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘
{title}
URL: {url}
æ¦‚è¦: {desc}

--- å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ---
> ã‚¿ã‚¤ãƒˆãƒ«ã¯æ„Ÿæƒ…ã‚’ã‚„ã•ã—ãè¨€èªåŒ–ã—ãŸå•ã„ã‹ã‘ã«ã—ã¦ãã ã•ã„(ä¾‹ï¼šã€Œâ€œãªã‚“ã§ã‹ã‚ã‹ã‚‰ãªã„ã‘ã©ã€ã‚‚ã‚„ã‚‚ã‚„ã™ã‚‹æ—¥ã«ã‚ãªãŸã¯ã©ã†ã™ã‚‹ï¼Ÿâ€ã€)

> ãƒªãƒ¼ãƒ‰æ–‡ã¨ã—ã¦ã€èª²é¡Œã¨è§£æ±ºç­–ã‚’æç¤ºã—ã¾ã™ã€‚ã‚ˆãã‚ã‚‹â€œã“ã“ã‚ã®ã‚‚ã‚„ã‚‚ã‚„â€ã‚’å–ã‚Šä¸Šã’ã¦ã€  
> ãã®æ°—æŒã¡ãŒã©ã“ã‹ã‚‰æ¥ã‚‹ã®ã‹ã€ã©ã†å‘ãåˆã†ã¨ã‚ˆã„ã‹ã¨ã„ã†**è€ƒãˆæ–¹ã®ãƒ’ãƒ³ãƒˆ**ã‚’ã‚„ã•ã—ãæç¤ºã—ã¦ãã ã•ã„ã€‚


## å®Ÿéš›ã«èµ·ãã‚‹ã“ã¨ã‚’æƒ³åƒã—ã¦ã¿ã‚ˆã†

> ä»¥ä¸‹ã®ã‚ˆã†ãªå…·ä½“çš„ãªã‚·ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã¤ã‘ã¾ã™ã€‚
> å„ã‚±ãƒ¼ã‚¹å†…å®¹ã¯ã€ã€Œäº‹å®Ÿâ†’ãã®æ™‚ã©ã†æ€ã£ãŸã‹ï¼Ÿâ†’ã©ã†ã‚„ã£ã¦å‘ãåˆã£ãŸã‹ï¼Ÿã€ã®é †ç•ªã§200æ–‡å­—ç¨‹åº¦ã®ã‚¹ãƒˆãƒ¼ãƒªä»•ç«‹ã¦ã«ã—ã¦ãã ã•ã„ï¼ˆç›®å®‰ï¼š3ã¤ï¼‰ï¼š

### ã‚±ãƒ¼ã‚¹Aï¼šå‹é”ã¨ã®ã™ã‚Œé•ã„
### ã‚±ãƒ¼ã‚¹Bï¼šå®¶åº­ã§ã®å°ã•ãªã‚±ãƒ³ã‚«  
### ã‚±ãƒ¼ã‚¹Cï¼šã²ã¨ã‚Šã®ã¨ãã«æ„Ÿã˜ãŸã•ã¿ã—ã•


## ğŸ’¬ è¦ªå­ã§è€ƒãˆã‚‹ï¼šå¯¾è©±ã®ãƒ’ãƒ³ãƒˆ

> ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å¾¹åº•ã—ã¦ã€ãƒªã‚¹ãƒˆå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«NGï¼‰
> Yes/Noã§ã¯ãªãã€è‡ªç”±ã«è€ƒãˆãŸããªã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ãªå•ã„  
> å°å­¦ç”Ÿã§ã‚‚ç†è§£ã—ã‚„ã™ã„è¨€è‘‰ã§  
> å„å•ã„ã«ã€Œã­ã‚‰ã„ï¼ˆæ•™è‚²çš„æ„å›³ï¼‰ã€ã‚’è¨˜è¼‰ã™ã‚‹ã“ã¨


- **è³ªå•ä¾‹ï¼š** ã‚‚ã—ã€æ°—æŒã¡ã‚’ã€Œè‰²ã€ã§è¡¨ã™ã¨ã—ãŸã‚‰ã€ä»Šæ—¥ã¯ä½•è‰²ï¼Ÿ  
  **ã­ã‚‰ã„ï¼š** æƒ³åƒåŠ›ãƒ»æ„Ÿæƒ…ã®è¨€èªåŒ–

- **è³ªå•ä¾‹ï¼š** ã„ã‚„ãªã“ã¨ãŒã‚ã£ãŸã¨ãã€å®¶æ—ã§ã©ã‚“ãªç´„æŸã‚’ã—ãŸã‚‰å®‰å¿ƒã§ããã†ï¼Ÿ  
  **ã­ã‚‰ã„ï¼š** è¡Œå‹•ã®é¸æŠãƒ»å®¶åº­å†…ã®ãƒ«ãƒ¼ãƒ«ã¥ãã‚Š

- **è³ªå•ä¾‹ï¼š** å‹ã ã¡ãŒå›°ã£ã¦ã„ãŸã‚‰ã€ã©ã‚“ãªå£°ã‚’ã‹ã‘ãŸã„ï¼Ÿ  
  **ã­ã‚‰ã„ï¼š** å…±æ„ŸåŠ›ãƒ»ç¤¾ä¼šæ€§


## ãã¿ãªã‚‰ã©ã†ã™ã‚‹ï¼Ÿ
> èª­å¾Œã«**è‡ªåˆ†ã‚’è¦‹ã¤ã‚ãŸããªã‚‹ã‚ˆã†ãªä½™éŸ»**ã‚’æ®‹ã—ã¦ãã ã•ã„  
> ã‚³ãƒ¡ãƒ³ãƒˆã‚„æ„Ÿæƒ³ã‚’ä¿ƒã™æ–‡ï¼ˆä¾‹ï¼šã€Œã‚ãªãŸã¯ã©ã†æ€ã£ãŸï¼ŸSNSã§æ•™ãˆã¦ã­ã€ï¼‰ã‚’åŠ ãˆã¦ã‚‚OK
"""

    return [
        {
            "role": "system",
            "content": "ã‚ãªãŸã¯ã€StudyRiverï¼ˆã‚¹ã‚¿ãƒªãƒï¼‰ã€ã®æœªæ¥ä»®èª¬ãƒ¡ãƒ‡ã‚£ã‚¢ã«è¨˜äº‹ã‚’å¯„ç¨¿ã™ã‚‹ã€èª­è€…ã¨ã®ä¼šè©±ã‚’å¤§åˆ‡ã«ã™ã‚‹é›‘èªŒãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚å°‚é–€çš„ã™ããšã€è¦ªã—ã¿ã‚„ã™ãã€æƒ³åƒã‚’å¼•ãå‡ºã™æ–‡ç« ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚"
        },
        {
            "role": "user",
            "content": user_prompt
        }
    ]

def generate_article(messages):
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=messages,
        temperature=0.7,
        max_tokens=1500
    )
    return response.choices[0].message.content

def save_markdown(title, content):
    date_str = datetime.now().strftime("%Y-%m-%d")
    slug = sanitize_title(title)[:40]
    filename = f"{OUTPUT_DIR}{date_str}-{slug}.md"
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    with open(filename, "w", encoding="utf-8") as f:
        f.write(content)
    print(f"âœ… Saved: {filename}")

def main():
    with open(INPUT_FILE, "r", encoding="utf-8") as f:
        news = json.load(f)

    if not news.get("articles"):
        print("âŒ ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
        return

    messages = build_messages(news)
    article = generate_article(messages)
    title = news["articles"][0]["title"]
    save_markdown(title, article)

if __name__ == "__main__":
    main()
