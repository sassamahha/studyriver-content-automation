import os
import json
import re
from datetime import datetime
from openai import OpenAI

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

INPUT_FILE = "tmp/news_kids_main.json"
OUTPUT_DIR = "posts/news/kids/"

def sanitize_title(title):
    return re.sub(r"[^a-zA-Z0-9\-]", "-", title.lower()).strip("-")

def build_messages(news):
    title = news["articles"][0]["title"]
    url = news["articles"][0]["url"]
    desc = news["articles"][0]["description"]

    user_prompt = f"""以下のニュースをもとに、未来仮説メディア『StudyRiver（スタリバ）』向けの“雑誌風読み物”記事を構成してください。

【ニュース】
タイトル: {title}
URL: {url}
概要: {desc}

--- 出力フォーマット ---
# （ニュースをもとにした、日本語の仮説的な問いかけタイトルにしてください）

{{リード文として、今起きている出来事やニュースに触れたあと、「この流れが続いたら？」という問いを提示し、読者にIFを投げかけてください}}

## 今日のニュース：何が起きているのか？
引用元:  
{{URL}}

#### 要約：
- {{ポイント1}}
- {{ポイント2}}
- {{ポイント3}}
→　箇条書きで、構造的に3ポイント程度を説明してください。専門用語は避け、わかりやすい文章を心がけてください。

## 背景にある時代の変化

#### ① おとな視点
> ニュースが起きた背景にある「社会制度・法律・インフラ・業界の慣習」など、あくまで普遍的・構造的な問題点だけを整理する（宗教的・文化的な背景は含めない）。  
> →「この問題は、なぜ今起きたのか？」「どんな仕組みがそうさせたのか？」

#### ② こども視点
> このニュースが、こどもたちの日常や身近な選択にどう影響しているかを具体的に示す。  
> →「この問題は、私たち（こども）の◯◯とどうつながっているのか？」という視点を意識する。

#### ③ 親の視点
> この社会構造を理解したうえで、親として何を知るべきか、またどう行動すべきかを明確にする。 
> →「社会が変わるのを待つのか、それとも自分自身の考え方や行動を変えるか？」という問いかけを含めて考える。

→ ３つの背景は独立した囲みブロックにしてください。文章は自然につないでください。尚、多言語に翻訳しているため、宗教や特定の文化的価値観に関連した説明は避け、多様な国・地域で共通して理解される客観的な視点に限定する。

## もしこのまま進んだら、未来はどうなる？
→ 各仮説は以下の形式で、物語を語るように「3つ（IF1,IF2,IF3）」展開してください。尚、宗教や特定の文化的価値観に関連した説明は避け、多様な国・地域で共通して理解される客観的な視点に限定すること。
#### 仮説1（中立）：○○が当たり前になる未来  
> {{仮説1の説明}}

#### 仮説2（楽観）：○○が大きく発展する未来  
> {{仮説2の説明}}

#### 仮説3（悲観）：○○が失われていく未来  
> {{仮説3の説明}}

→ ３つの仮説は独立した囲みブロックにしてください。各仮説の説明は下記３構成で、文章は自然につないでください。
- 最初に直接的な変化
- 次に波及的な変化
- 最後に価値観の変化

## ご家庭で話せる問い（親子対話のヒント）
→ 以下のルールに従って、親子で話せる問いを3つ生成して、必ずリスト形式で出力してください（テーブル形式はNG）
    - 各問いは、子どもが身近な視点からテーマについて考え、自分ごととして話せるような問いとしてください。
    - 全体構成：表形式（「質問例」と「ねらい」の2列）で出力
    - 対象年齢：主に小学校低〜中学年
    - ねらいの種類は「想像力」「行動の選択」「協働的学び」「社会参加の考察」などの教育的意図を含める
    - 質問の形式は、Yes/Noではなく、子どもが自由に考えたり話したくなるような問いにする
    - 注意事項：宗教・文化的価値観に依存しない、国際的に通用する問いとすること

出力する質問のバリエーション:
- **質問例:** ○○がもっと身近になったら、あなたはどんなルールを作りたい？  
  **ねらい:** 行動の選択・ルールメイキング  
- **質問例:** ○○を知らないお友達に伝えるとしたら、どんな言葉や絵を使う？  
  **ねらい:** 協働的学び・コミュニケーション  
- **質問例:** ○○によって困っている人がいたら、地域でどんな助け方ができるかな？  
  **ねらい:** 社会参加の考察・共感力  
- **質問例:** 未来の学校では○○をどう使うと楽しく学べると思う？  
  **ねらい:** 想像力・学習デザイン  
- **質問例:** ○○がなくなった世界を想像して、毎日の暮らしはどう変わる？  
  **ねらい:** 問題解決力・逆転発想  
- **質問例:** ○○について友達と意見が分かれたら、話し合いを進めるために何ができる？  
  **ねらい:** 協働的学び・合意形成  
- **質問例:** ○○を安心して使うために、家族でどんな約束を決めたい？  
  **ねらい:** 行動の選択・デジタルシチズンシップ  
- **質問例:** ○○で得た情報が本当か確かめるとしたら、どんな方法がある？  
  **ねらい:** メディアリテラシー・批判的思考  
- **質問例:** ○○が環境に与える影響を減らすには、どんな工夫ができる？  
  **ねらい:** 社会参加の考察・サステナビリティ  
- **質問例:** ○○を通じて新しい友達ができたら、一緒にどんな活動をしてみたい？  
  **ねらい:** 協働的学び・多様性理解

## まとめ：10年後を予習して、今日を選ぶために
→ コメントを促すような読者への問いかけで締め、雑誌風に書いてください。  
例：「あなたはどんな未来を思い描きましたか？SNS引用やコメントでぜひ教えてください。」"""

    return [
        {
            "role": "system",
            "content": "あなたは『StudyRiver（スタリバ）』の未来仮説メディアに記事を寄稿する、読者との会話を大切にする雑誌ライターです。専門的すぎず、親しみやすく、想像を引き出す文章を心がけてください。"
        },
        {
            "role": "user",
            "content": user_prompt
        }
    ]

def generate_article(messages):
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=messages,
        temperature=0.7,
        max_tokens=1500
    )
    return response.choices[0].message.content

def save_markdown(title, content):
    date_str = datetime.now().strftime("%Y-%m-%d")
    slug = sanitize_title(title)[:40]
    filename = f"{OUTPUT_DIR}{date_str}-{slug}.md"
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    with open(filename, "w", encoding="utf-8") as f:
        f.write(content)
    print(f"✅ Saved: {filename}")

def main():
    with open(INPUT_FILE, "r", encoding="utf-8") as f:
        news = json.load(f)

    if not news.get("articles"):
        print("❌ ニュース記事が見つかりませんでした。")
        return

    messages = build_messages(news)
    article = generate_article(messages)
    title = news["articles"][0]["title"]
    save_markdown(title, article)

if __name__ == "__main__":
    main()
